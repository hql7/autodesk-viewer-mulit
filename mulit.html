<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>多模型有序聚合</title>
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/6.*/style.min.css"
          type="text/css">
    <link rel="stylesheet" href="./static/clear.css">
    <style>
        .msg-box{
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 9;
            width: 200px;
            height: 240px;
            background: rgba(250,200,209,.6);
            border-radius: 3px;
        }

        .msg-title{
            line-height: 36px;
            padding: 0 15px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .msg-main{
            padding: 10px 15px;
            font-size: 16px;
            line-height: 28px;
            color: #333;
        }
    </style>
</head>
<body>
<div id="myViewer"></div>
<div class="msg-box">
    <h3 class="msg-title">构件信息：</h3>
    <div class="msg-main">测试信息</div>
</div>
<script src="static/jquery.min.js"></script>
<script src="https://developer.api.autodesk.com/derivativeservice/v2/viewers/three.min.js?v=v2.17"></script>
<script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/6.*/viewer3D.min.js"></script>
<script>
    (function () {
        //replace with your own urns
        this.urn_model1 = "./bim/1/0.svf";
        this.urn_model2 = "./bim/2/0.svf";
        this.urn_model3 = "./bim/3/0.svf";
        this.urn_model4 = "./bim/4/0.svf";
        this.urn_model5 = "./bim/5/xiaojiaoche.3DS.svf";
        this.urn_model6 = "./cailiao/travel/0.svf";
        this.urn_model7 = "./bim/6/Sphere.svf";

        //model info array
        this.modelArray = [
            {
                modelName: 'urn_model1',
                path: urn_model1,
                modelObj: null
            },
            {
                modelName: 'urn_model2',
                path: urn_model2,
                modelObj: null
            },
            {
                modelName: 'urn_model3',
                path: urn_model3,
                modelObj: null
            },
            {
                modelName: 'urn_model4',
                path: urn_model4,
                modelObj: null
            },
            {
                modelName: 'urn_model5',
                path: urn_model7,
                modelObj: null
            },
            {
                modelName: 'urn_model6',
                path: urn_model7,
                modelObj: null
            }
        ];

        //viewer object
        this.viewer = null;

        function start() {
            //option to initialize viewer.
            var options = {
                env: 'Local',
                offline: 'true',
                useADP: false,
            };

            //It looks the static function of Viewer does not support ES6
            //still use ES5

            Autodesk.Viewing.Initializer(options, function onInitialized() {
                //get the viewer div
                var viewerDiv = document.getElementById('myViewer');
                //initialize the viewer object
                viewer = new Autodesk.Viewing.Private.GuiViewer3D(viewerDiv, {
                    extensions: ["Autodesk.Viewing.MarkupsCore", "Autodesk.Viewing.ZoomWindow"]
                });
                //load model one by one in sequence
                globalPromise(modelArray);
                // 多模型选择构建
                viewer.addEventListener(Autodesk.Viewing.AGGREGATE_SELECTION_CHANGED_EVENT, function (event) {
                    /*_viewer.navigation.setWorldUpVector(new THREE.Vector3(0, 0, 1));

                    var newPos = new THREE.Vector3(0, 0, -100);
                    var newTarget = new THREE.Vector3(0, 0, 0);
                    _viewer.navigation.setView(newPos, newTarget);

                    _viewer.fitToView(true);*/
                    if (event.selections.length === 0) {
                        // viewer.clearThemingColors();
                        return;
                    }

                    var color = new THREE.Vector4(0, 0.5, 0, 1);
                    var id = event.selections[0].dbIdArray[0];
                    viewer.setThemingColor(id, color);

                    var select_info = viewer.getAggregateSelection();
                    var html = '<p>当前构建dbid：'+select_info[0].selection[0]+'</p>';
                    html+=  '<p>当前模型id：'+select_info[0].model.id+'</p>';
                    html+=  '<p>模型地址：'+select_info[0].model.getData().urn+'</p>';
                    $(".msg-main").html(html);

                    console.log(event); // 当前选中信息集
                    console.log(select_info); // 当前选中id
                    /* var hitTest = viewer.clientToWorld(event.offsetX,event.offsetY, false);
                     console.log(hitTest)
                      const markupInfo = {
                          fragId: hitTest.fragId,
                          point: hitTest.point,
                          dbId: hitTest.dbId,
                          size: 40
                      }
                      var markup = new pointcloudmarkup(viewer, options);
                      markup.addMarkup(markupInfo);
                      markup.startAnimation();
                       const loop = (t) => {
                           window.requestAnimationFrame(loop);
                           this.markup.update(t);
                       };
                       loop(0.0);*/
                });
                // 监视镜头移动
                viewer.addEventListener(Autodesk.Viewing.CAMERA_TRANSITION_COMPLETED, function(){
                });
                // 动画初始化触发
                viewer.addEventListener(Autodesk.Viewing.ANIMATION_READY_EVENT, function(e){
                    console.log(e)
                });
            });

            // 旋转扩展
            class RotateExt extends Autodesk.Viewing.Extension {
                constructor(viewer, options) {
                    super();
                }

                load() {
                    viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, this.onSelectionChanged);
                    return true;
                }

                unload() {
                    viewer.removeEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, this.onSelectionChanged);
                    return true;
                }

                /**!
                 * 关键函数
                 */
                onSelectionChanged(event) {
                    console.log(event, 1)
                    const quaternion = new THREE.Quaternion();
                    // 设置旋转量 - 依 Y 轴旋转构件 180 度
                    quaternion.setFromAxisAngle(new THREE.Vector3(0, 1, 0), Math.PI);

                    const model = event.model;
                    const fragIdsArray = event.fragIdsArray;

                    fragIdsArray.forEach((fragId, idx) => {
                        const fragProxy = this.viewer.impl.getFragmentProxy(model, fragId);

                        fragProxy.getAnimTransform();

                        const position = new THREE.Vector3(fragProxy.position.x, fragProxy.position.y, fragProxy.position.z);
                        position.applyQuaternion(quaternion);

                        fragProxy.position = position;
                        fragProxy.quaternion.multiplyQuaternions(quaternion, fragProxy.quaternion);

                        if (idx === 0) {
                            const euler = new THREE.Euler();
                            euler.setFromQuaternion(fragProxy.quaternion, 0);
                        }

                        fragProxy.updateAnimTransform();
                    });

                    this.viewer.impl.sceneUpdated(true);
                };
            }

            // 注册旋转扩展
            Autodesk.Viewing.theExtensionManager.registerExtension('Autodesk.ADN.Viewing.Extension.RotateTool', RotateExt);

            // 移动扩展
            class TranslateExt extends Autodesk.Viewing.Extension {
                constructor(viewer, options) {
                    super();
                }

                load() {
                    viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, this.onSelectionChanged);
                    return true;
                }

                unload() {
                    viewer.removeEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, this.onSelectionChanged);
                    return true;
                }

                /**!
                 * 关键函数
                 */
                onSelectionChanged(event) {

                    // 设置移动量 - 向 X 轴移动 -100 单位
                    const offset = new THREE.Vector3(-100, 0, 0);

                    const model = event.model;
                    const fragIdsArray = event.fragIdsArray;

                    fragIdsArray.forEach((fragId, idx) => {
                        const fragProxy = this.viewer.impl.getFragmentProxy(model, fragId);

                        fragProxy.getAnimTransform();

                        const position = new THREE.Vector3(
                            fragProxy.position.x + offset.x,
                            fragProxy.position.y + offset.y,
                            fragProxy.position.z + offset.z
                        );

                        fragProxy.position = position;

                        fragProxy.updateAnimTransform();
                    });

                    this.viewer.impl.sceneUpdated(true);
                };
            }

            // 注册移动扩展
            Autodesk.Viewing.theExtensionManager.registerExtension('Autodesk.ADN.Viewing.Extension.TranslateTool', TranslateExt);
        }

        //load model by promise
        globalPromise = (modelArray) => {
            var _this = this;

            //each promise function
            //input the index of model array

            function promiseEachModel(index) {
                return new Promise((resolve, reject) => {
                    var modelName = modelArray[index].modelName;
                    var _index = index;

                    _this.globalDocumentLoad(modelArray[index],
                        _onLoadModelSuccess,
                        _onLoadModelError);

                    //when the model is loaded
                    function _onLoadModelSuccess(model) {
                        if (index === 0) {
                            /*console.log("model.geomPolyCount: %f", model.geomPolyCount());
                            console.log("model.getBoundingBox: %O", model.getBoundingBox());
                            console.log("model.getData : %O", model.getData());
                            console.log("model.getDefaultCamera: %O", model.getDefaultCamera());
                            // console.log("model.getLayersRoot: %O", model.getLayersRoot());
                            console.log("model.getRoot: %O", model.getRoot ());
                            console.log("model.getRootId : %f", model.getRootId());
                            console.log("model.getUnitScale: %f", model.getUnitScale());
                            console.log("model.getUnitString: %s", model.getUnitString());
                            console.log("model.getUpVector: %O", model.getUpVector());
                            console.log("model.instancePolyCount: %f", model.instancePolyCount());
                            console.log("model.is2d: %s", model.is2d());
                            console.log("model.isLoadDone: %s", model.isLoadDone());
                            console.log("model.isObjectTreeCreated: %s", model.isObjectTreeCreated());*/
                        }
                        _this.viewer.addEventListener(
                            Autodesk.Viewing.GEOMETRY_LOADED_EVENT,
                            _onGeometryLoaded);

                        //map this item with the corresponding model in case of use
                        modelArray[index].modelObj = model
                    }

                    function _onLoadModelError(viewerErrorCode) {
                        console.error(modelName +
                            ': Load Model Error, errorCode:' +
                            viewerErrorCode);
                        //any error
                        reject(modelName + ' Loading Failed!' + viewerErrorCode);
                    }

                    function _onGeometryLoaded(evt) {
                        if (!["urn_model2", "urn_model3", "urn_model5", "urn_model6"].includes(modelArray[index].modelName)) {
                            // _this.viewer.fitToView(evt.model.id)
                            var red = new THREE.Vector4(0, 0.5, 0, 0.5);
                            var it = evt.model.getData().instanceTree;
                            // viewer.setThemingColor(it.nodeAccess.rootId, red);
                            // console.log(it.nodeAccess.rootId)
                            // console.log(it)
                            for (var i in it.nodeAccess.dbIdToIndex) {
                                _this.viewer.setThemingColor(i, red, evt.model);
                            }
                        }
                        if (modelArray[index].modelName === "urn_model5") {
                            // console.log(evt.model.getData())
                            // 调整焦距
                            var focal = _this.viewer.getFocalLength();
                            _this.viewer.setFocalLength(focal-20);
                            // 聚焦指定模型
                            _this.viewer.fitToView([1], evt.model);
                            var red = new THREE.Vector4(0.5, 0, 0, 0.5);
                            var it = evt.model.getData().instanceTree;
                            // viewer.setThemingColor(it.nodeAccess.rootId, red);
                            // console.log(it.nodeAccess.rootId)
                            // console.log(it)
                            if (it) {
                                for (var i in it.nodeAccess.dbIdToIndex) {
                                    _this.viewer.setThemingColor(i, red, evt.model);
                                }
                            }
                        }
                        if (modelArray[index].modelName === "urn_model6") {
                            // console.log(evt.model.getData())

                            // console.log(_this.viewer.fitToView)
                            var red = new THREE.Vector4(0, 0, 0.5, 0.5);
                            var it = evt.model.getData().instanceTree;
                            // viewer.setThemingColor(it.nodeAccess.rootId, red);
                            // console.log(it)
                            if (it) {
                                for (var i in it.nodeAccess.dbIdToIndex) {
                                    _this.viewer.setThemingColor(i, red, evt.model);
                                }
                            }

                        }

                        _this.viewer.removeEventListener(
                            Autodesk.Viewing.GEOMETRY_LOADED_EVENT,
                            _onGeometryLoaded);
                        resolve(modelArray[index]);
                    }
                }); //end of new promise
            } //end of each promise function

            //build the index array
            // this.modelArray.length
            var indexArr = Array.apply(null, Array(this.modelArray.length)).map((item, index) => index);
            //proces each promise
            //refer to http://jsfiddle.net/jfriend00/h3zaw8u8/
            function processArray(array, fn) {
                var results = [];
                return array.reduce(function (p, item) {
                    return p.then(function () {
                        return fn(item).then(function (data) {
                            results.push(data);
                            return results;
                        });
                    });
                }, Promise.resolve());
            }

            //start to process
            processArray(indexArr, promiseEachModel).then(function (result) {
                //全部加载完成
                console.log(result);
                result.forEach(item => { // 透明目标模型
                    if (["urn_model2", "urn_model3"].includes(item.modelName)) viewer.hide(item.modelObj.id, item.modelObj);
                });
                // var old_globalOffset = result[0].modelObj.getData().globalOffset;
                /*result[0].modelObj.setData({
                    globalOffset:{
                        x: old_globalOffset.x + 1000,
                        y: old_globalOffset.y + 1000,
                        z: old_globalOffset.z + 100,
                    }
                })*/
                // 设置移动量 - 向 X 轴移动 -100 单位
                /* const offset = new THREE.Vector3(-1000, 1000, 450);
                 const model_ = result[0].modelObj;
                 const fragIdsArray =  getLeafFragIds (
                     model_, model_.id);
                 console.log(fragIdsArray)
                 // console.log(viewer.impl)
                 fragIdsArray.forEach((fragId, idx) => {
                     const fragProxy = viewer.impl.getFragmentProxy(model_, fragId);

                     fragProxy.getAnimTransform();

                     const position = new THREE.Vector3(
                         fragProxy.position.x + offset.x,
                         fragProxy.position.y + offset.y,
                         fragProxy.position.z + offset.z
                     );

                     fragProxy.position = position;

                     fragProxy.updateAnimTransform();
                 });
                 viewer.impl.sceneUpdated(true);*/
            }, function (reason) {
                console.log(reason);
            });
        }; //end of function globalPromise

        var mat = new THREE.Matrix4();
        //input the transformation
        var loadOptions = {
            placementTransform: mat,
            /*globalOffset: {
                x: 0,
                y: 0,
                z: 0
            }, // to align the models*/
            // sharedPropertyDbPath: doc.getPropertyDbPath()
        };
        //when document is being loaded
        globalDocumentLoad = (doc, _onLoadModelSuccess, _onLoadModelError) => {
            //if this is the first model
            if (doc.modelName === "urn_model1") {
                //load the first model
                this.viewer.start(doc.path,
                    loadOptions,
                    _onLoadModelSuccess,
                    _onLoadModelError);

            } else {
                //other models
                if (doc.modelName === "urn_model5") {
                    // loadOptions.globalOffset = {x: 100, y: 0, z:100};
                } else if (doc.modelName === "urn_model6") {
                    loadOptions.globalOffset = {x: 2.55555555444, y: 0.111111111111, z: 2.11111111111111};
                } else {
                    delete loadOptions.globalOffset
                }

                this.viewer.loadModel(doc.path,
                    loadOptions,
                    _onLoadModelSuccess,
                    _onLoadModelError);
            }
        };

        // 根据model获取FragIds
        function getLeafFragIds(model, leafId) {
            const instanceTree = model.getData().instanceTree;
            const fragIds = [];
            instanceTree.enumNodeFragments(leafId, function (fragId) {
                fragIds.push(fragId);
            });
            return fragIds;
        }

        // 调用
        start();
    }())
</script>
</body>
</html>
